"use strict";const{EventEmitter:EventEmitter}=require("events"),fs=require("fs"),sysPath=require("path"),{promisify:promisify}=require("util"),readdirp=require("readdirp"),anymatch=require("anymatch").default,globParent=require("glob-parent"),isGlob=require("is-glob"),braces=require("braces"),normalizePath=require("normalize-path"),NodeFsHandler=require("./lib/nodefs-handler"),FsEventsHandler=require("./lib/fsevents-handler"),{EV_ALL:EV_ALL,EV_READY:EV_READY,EV_ADD:EV_ADD,EV_CHANGE:EV_CHANGE,EV_UNLINK:EV_UNLINK,EV_ADD_DIR:EV_ADD_DIR,EV_UNLINK_DIR:EV_UNLINK_DIR,EV_RAW:EV_RAW,EV_ERROR:EV_ERROR,STR_CLOSE:STR_CLOSE,STR_END:STR_END,BACK_SLASH_RE:BACK_SLASH_RE,DOUBLE_SLASH_RE:DOUBLE_SLASH_RE,SLASH_OR_BACK_SLASH_RE:SLASH_OR_BACK_SLASH_RE,DOT_RE:DOT_RE,REPLACER_RE:REPLACER_RE,SLASH:SLASH,SLASH_SLASH:SLASH_SLASH,BRACE_START:BRACE_START,BANG:BANG,ONE_DOT:ONE_DOT,TWO_DOTS:TWO_DOTS,GLOBSTAR:GLOBSTAR,SLASH_GLOBSTAR:SLASH_GLOBSTAR,ANYMATCH_OPTS:ANYMATCH_OPTS,STRING_TYPE:STRING_TYPE,FUNCTION_TYPE:FUNCTION_TYPE,EMPTY_STR:EMPTY_STR,EMPTY_FN:EMPTY_FN,isWindows:isWindows,isMacos:isMacos,isIBMi:isIBMi}=require("./lib/constants"),stat=promisify(fs.stat),readdir=promisify(fs.readdir),arrify=(t=[])=>Array.isArray(t)?t:[t],flatten=(t,s=[])=>(t.forEach((t=>{Array.isArray(t)?flatten(t,s):s.push(t)})),s),unifyPaths=t=>{const s=flatten(arrify(t));if(!s.every((t=>typeof t===STRING_TYPE)))throw new TypeError(`Non-string provided as watch path: ${s}`);return s.map(normalizePathToUnix)},toUnix=t=>{let s=t.replace(BACK_SLASH_RE,SLASH),e=!1;for(s.startsWith(SLASH_SLASH)&&(e=!0);s.match(DOUBLE_SLASH_RE);)s=s.replace(DOUBLE_SLASH_RE,SLASH);return e&&(s=SLASH+s),s},normalizePathToUnix=t=>toUnix(sysPath.normalize(toUnix(t))),normalizeIgnored=(t=EMPTY_STR)=>s=>typeof s!==STRING_TYPE?s:normalizePathToUnix(sysPath.isAbsolute(s)?s:sysPath.join(t,s)),getAbsolutePath=(t,s)=>sysPath.isAbsolute(t)?t:t.startsWith(BANG)?BANG+sysPath.join(s,t.slice(1)):sysPath.join(s,t),undef=(t,s)=>void 0===t[s];class DirEntry{constructor(t,s){this.path=t,this._removeWatcher=s,this.items=new Set}add(t){const{items:s}=this;s&&t!==ONE_DOT&&t!==TWO_DOTS&&s.add(t)}async remove(t){const{items:s}=this;if(!s)return;if(s.delete(t),s.size>0)return;const e=this.path;try{await readdir(e)}catch(t){this._removeWatcher&&this._removeWatcher(sysPath.dirname(e),sysPath.basename(e))}}has(t){const{items:s}=this;if(s)return s.has(t)}getChildren(){const{items:t}=this;if(t)return[...t.values()]}dispose(){this.items.clear(),delete this.path,delete this._removeWatcher,delete this.items,Object.freeze(this)}}const STAT_METHOD_F="stat",STAT_METHOD_L="lstat";class WatchHelper{constructor(t,s,e,i){this.fsw=i,this.path=t=t.replace(REPLACER_RE,EMPTY_STR),this.watchPath=s,this.fullWatchPath=sysPath.resolve(s),this.hasGlob=s!==t,t===EMPTY_STR&&(this.hasGlob=!1),this.globSymlink=!(!this.hasGlob||!e)&&void 0,this.globFilter=!!this.hasGlob&&anymatch(t,void 0,ANYMATCH_OPTS),this.dirParts=this.getDirParts(t),this.dirParts.forEach((t=>{t.length>1&&t.pop()})),this.followSymlinks=e,this.statMethod=e?"stat":"lstat"}checkGlobSymlink(t){return void 0===this.globSymlink&&(this.globSymlink=t.fullParentDir!==this.fullWatchPath&&{realPath:t.fullParentDir,linkPath:this.fullWatchPath}),this.globSymlink?t.fullPath.replace(this.globSymlink.realPath,this.globSymlink.linkPath):t.fullPath}entryPath(t){return sysPath.join(this.watchPath,sysPath.relative(this.watchPath,this.checkGlobSymlink(t)))}filterPath(t){const{stats:s}=t;if(s&&s.isSymbolicLink())return this.filterDir(t);const e=this.entryPath(t);return(!this.hasGlob||typeof this.globFilter!==FUNCTION_TYPE||this.globFilter(e))&&this.fsw._isntIgnored(e,s)&&this.fsw._hasReadPermissions(s)}getDirParts(t){if(!this.hasGlob)return[];const s=[];return(t.includes(BRACE_START)?braces.expand(t):[t]).forEach((t=>{s.push(sysPath.relative(this.watchPath,t).split(SLASH_OR_BACK_SLASH_RE))})),s}filterDir(t){if(this.hasGlob){const s=this.getDirParts(this.checkGlobSymlink(t));let e=!1;this.unmatchedGlob=!this.dirParts.some((t=>t.every(((t,i)=>(t===GLOBSTAR&&(e=!0),e||!s[0][i]||anymatch(t,s[0][i],ANYMATCH_OPTS))))))}return!this.unmatchedGlob&&this.fsw._isntIgnored(this.entryPath(t),t.stats)}}class FSWatcher extends EventEmitter{constructor(t){super();const s={};t&&Object.assign(s,t),this._watched=new Map,this._closers=new Map,this._ignoredPaths=new Set,this._throttled=new Map,this._symlinkPaths=new Map,this._streams=new Set,this.closed=!1,undef(s,"persistent")&&(s.persistent=!0),undef(s,"ignoreInitial")&&(s.ignoreInitial=!1),undef(s,"ignorePermissionErrors")&&(s.ignorePermissionErrors=!1),undef(s,"interval")&&(s.interval=100),undef(s,"binaryInterval")&&(s.binaryInterval=300),undef(s,"disableGlobbing")&&(s.disableGlobbing=!1),s.enableBinaryInterval=s.binaryInterval!==s.interval,undef(s,"useFsEvents")&&(s.useFsEvents=!s.usePolling);FsEventsHandler.canUse()||(s.useFsEvents=!1),undef(s,"usePolling")&&!s.useFsEvents&&(s.usePolling=isMacos),isIBMi&&(s.usePolling=!0);const e=process.env.CHOKIDAR_USEPOLLING;if(void 0!==e){const t=e.toLowerCase();s.usePolling="false"!==t&&"0"!==t&&("true"===t||"1"===t||!!t)}const i=process.env.CHOKIDAR_INTERVAL;i&&(s.interval=Number.parseInt(i,10)),undef(s,"atomic")&&(s.atomic=!s.usePolling&&!s.useFsEvents),s.atomic&&(this._pendingUnlinks=new Map),undef(s,"followSymlinks")&&(s.followSymlinks=!0),undef(s,"awaitWriteFinish")&&(s.awaitWriteFinish=!1),!0===s.awaitWriteFinish&&(s.awaitWriteFinish={});const r=s.awaitWriteFinish;r&&(r.stabilityThreshold||(r.stabilityThreshold=2e3),r.pollInterval||(r.pollInterval=100),this._pendingWrites=new Map),s.ignored&&(s.ignored=arrify(s.ignored));let n=0;this._emitReady=()=>{n++,n>=this._readyCount&&(this._emitReady=EMPTY_FN,this._readyEmitted=!0,process.nextTick((()=>this.emit(EV_READY))))},this._emitRaw=(...t)=>this.emit(EV_RAW,...t),this._readyEmitted=!1,this.options=s,s.useFsEvents?this._fsEventsHandler=new FsEventsHandler(this):this._nodeFsHandler=new NodeFsHandler(this),Object.freeze(s)}add(t,s,e){const{cwd:i,disableGlobbing:r}=this.options;this.closed=!1;let n=unifyPaths(t);return i&&(n=n.map((t=>{const s=getAbsolutePath(t,i);return r||!isGlob(t)?s:normalizePath(s)}))),n=n.filter((t=>t.startsWith(BANG)?(this._ignoredPaths.add(t.slice(1)),!1):(this._ignoredPaths.delete(t),this._ignoredPaths.delete(t+SLASH_GLOBSTAR),this._userIgnored=void 0,!0))),this.options.useFsEvents&&this._fsEventsHandler?(this._readyCount||(this._readyCount=n.length),this.options.persistent&&(this._readyCount*=2),n.forEach((t=>this._fsEventsHandler._addToFsEvents(t)))):(this._readyCount||(this._readyCount=0),this._readyCount+=n.length,Promise.all(n.map((async t=>{const i=await this._nodeFsHandler._addToNodeFs(t,!e,0,0,s);return i&&this._emitReady(),i}))).then((t=>{this.closed||t.filter((t=>t)).forEach((t=>{this.add(sysPath.dirname(t),sysPath.basename(s||t))}))}))),this}unwatch(t){if(this.closed)return this;const s=unifyPaths(t),{cwd:e}=this.options;return s.forEach((t=>{sysPath.isAbsolute(t)||this._closers.has(t)||(e&&(t=sysPath.join(e,t)),t=sysPath.resolve(t)),this._closePath(t),this._ignoredPaths.add(t),this._watched.has(t)&&this._ignoredPaths.add(t+SLASH_GLOBSTAR),this._userIgnored=void 0})),this}close(){if(this.closed)return this._closePromise;this.closed=!0,this.removeAllListeners();const t=[];return this._closers.forEach((s=>s.forEach((s=>{const e=s();e instanceof Promise&&t.push(e)})))),this._streams.forEach((t=>t.destroy())),this._userIgnored=void 0,this._readyCount=0,this._readyEmitted=!1,this._watched.forEach((t=>t.dispose())),["closers","watched","streams","symlinkPaths","throttled"].forEach((t=>{this[`_${t}`].clear()})),this._closePromise=t.length?Promise.all(t).then((()=>{})):Promise.resolve(),this._closePromise}getWatched(){const t={};return this._watched.forEach(((s,e)=>{const i=this.options.cwd?sysPath.relative(this.options.cwd,e):e;t[i||ONE_DOT]=s.getChildren().sort()})),t}emitWithAll(t,s){this.emit(...s),t!==EV_ERROR&&this.emit(EV_ALL,...s)}async _emit(t,s,e,i,r){if(this.closed)return;const n=this.options;isWindows&&(s=sysPath.normalize(s)),n.cwd&&(s=sysPath.relative(n.cwd,s));const h=[t,s];void 0!==r?h.push(e,i,r):void 0!==i?h.push(e,i):void 0!==e&&h.push(e);const a=n.awaitWriteFinish;let o;if(a&&(o=this._pendingWrites.get(s)))return o.lastChange=new Date,this;if(n.atomic){if(t===EV_UNLINK)return this._pendingUnlinks.set(s,h),setTimeout((()=>{this._pendingUnlinks.forEach(((t,s)=>{this.emit(...t),this.emit(EV_ALL,...t),this._pendingUnlinks.delete(s)}))}),"number"==typeof n.atomic?n.atomic:100),this;t===EV_ADD&&this._pendingUnlinks.has(s)&&(t=h[0]=EV_CHANGE,this._pendingUnlinks.delete(s))}if(a&&(t===EV_ADD||t===EV_CHANGE)&&this._readyEmitted){const e=(s,e)=>{s?(t=h[0]=EV_ERROR,h[1]=s,this.emitWithAll(t,h)):e&&(h.length>2?h[2]=e:h.push(e),this.emitWithAll(t,h))};return this._awaitWriteFinish(s,a.stabilityThreshold,t,e),this}if(t===EV_CHANGE){if(!this._throttle(EV_CHANGE,s,50))return this}if(n.alwaysStat&&void 0===e&&(t===EV_ADD||t===EV_ADD_DIR||t===EV_CHANGE)){const t=n.cwd?sysPath.join(n.cwd,s):s;let e;try{e=await stat(t)}catch(t){}if(!e||this.closed)return;h.push(e)}return this.emitWithAll(t,h),this}_handleError(t){const s=t&&t.code;return t&&"ENOENT"!==s&&"ENOTDIR"!==s&&(!this.options.ignorePermissionErrors||"EPERM"!==s&&"EACCES"!==s)&&this.emit(EV_ERROR,t),t||this.closed}_throttle(t,s,e){this._throttled.has(t)||this._throttled.set(t,new Map);const i=this._throttled.get(t),r=i.get(s);if(r)return r.count++,!1;let n;const h=()=>{const t=i.get(s),e=t?t.count:0;return i.delete(s),clearTimeout(n),t&&clearTimeout(t.timeoutObject),e};n=setTimeout(h,e);const a={timeoutObject:n,clear:h,count:0};return i.set(s,a),a}_incrReadyCount(){return this._readyCount++}_awaitWriteFinish(t,s,e,i){let r,n=t;this.options.cwd&&!sysPath.isAbsolute(t)&&(n=sysPath.join(this.options.cwd,t));const h=new Date,a=e=>{fs.stat(n,((n,h)=>{if(n||!this._pendingWrites.has(t))return void(n&&"ENOENT"!==n.code&&i(n));const o=Number(new Date);e&&h.size!==e.size&&(this._pendingWrites.get(t).lastChange=o);o-this._pendingWrites.get(t).lastChange>=s?(this._pendingWrites.delete(t),i(void 0,h)):r=setTimeout(a,this.options.awaitWriteFinish.pollInterval,h)}))};this._pendingWrites.has(t)||(this._pendingWrites.set(t,{lastChange:h,cancelWait:()=>(this._pendingWrites.delete(t),clearTimeout(r),e)}),r=setTimeout(a,this.options.awaitWriteFinish.pollInterval))}_getGlobIgnored(){return[...this._ignoredPaths.values()]}_isIgnored(t,s){if(this.options.atomic&&DOT_RE.test(t))return!0;if(!this._userIgnored){const{cwd:t}=this.options,s=this.options.ignored,e=s&&s.map(normalizeIgnored(t)),i=arrify(e).filter((t=>typeof t===STRING_TYPE&&!isGlob(t))).map((t=>t+SLASH_GLOBSTAR)),r=this._getGlobIgnored().map(normalizeIgnored(t)).concat(e,i);this._userIgnored=anymatch(r,void 0,ANYMATCH_OPTS)}return this._userIgnored([t,s])}_isntIgnored(t,s){return!this._isIgnored(t,s)}_getWatchHelpers(t,s){const e=s||this.options.disableGlobbing||!isGlob(t)?t:globParent(t),i=this.options.followSymlinks;return new WatchHelper(t,e,i,this)}_getWatchedDir(t){this._boundRemove||(this._boundRemove=this._remove.bind(this));const s=sysPath.resolve(t);return this._watched.has(s)||this._watched.set(s,new DirEntry(s,this._boundRemove)),this._watched.get(s)}_hasReadPermissions(t){if(this.options.ignorePermissionErrors)return!0;const s=511&(t&&Number.parseInt(t.mode,10)),e=Number.parseInt(s.toString(8)[0],10);return Boolean(4&e)}_remove(t,s,e){const i=sysPath.join(t,s),r=sysPath.resolve(i);if(e=null!=e?e:this._watched.has(i)||this._watched.has(r),!this._throttle("remove",i,100))return;e||this.options.useFsEvents||1!==this._watched.size||this.add(t,s,!0);this._getWatchedDir(i).getChildren().forEach((t=>this._remove(i,t)));const n=this._getWatchedDir(t),h=n.has(s);n.remove(s),this._symlinkPaths.has(r)&&this._symlinkPaths.delete(r);let a=i;if(this.options.cwd&&(a=sysPath.relative(this.options.cwd,i)),this.options.awaitWriteFinish&&this._pendingWrites.has(a)){if(this._pendingWrites.get(a).cancelWait()===EV_ADD)return}this._watched.delete(i),this._watched.delete(r);const o=e?EV_UNLINK_DIR:EV_UNLINK;h&&!this._isIgnored(i)&&this._emit(o,i),this.options.useFsEvents||this._closePath(i)}_closePath(t){this._closeFile(t);const s=sysPath.dirname(t);this._getWatchedDir(s).remove(sysPath.basename(t))}_closeFile(t){const s=this._closers.get(t);s&&(s.forEach((t=>t())),this._closers.delete(t))}_addPathCloser(t,s){if(!s)return;let e=this._closers.get(t);e||(e=[],this._closers.set(t,e)),e.push(s)}_readdirp(t,s){if(this.closed)return;const e={type:EV_ALL,alwaysStat:!0,lstat:!0,...s};let i=readdirp(t,e);return this._streams.add(i),i.once(STR_CLOSE,(()=>{i=void 0})),i.once(STR_END,(()=>{i&&(this._streams.delete(i),i=void 0)})),i}}exports.FSWatcher=FSWatcher;const watch=(t,s)=>{const e=new FSWatcher(s);return e.add(t),e};exports.watch=watch;
